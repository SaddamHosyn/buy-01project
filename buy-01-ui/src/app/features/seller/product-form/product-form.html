<div class="product-form-container">
  <!-- Header -->
  <mat-toolbar color="primary" class="form-header">
    <button mat-icon-button routerLink="/seller/dashboard" matTooltip="Back to Dashboard">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>
      @if (isEditMode()) {
      <mat-icon>edit</mat-icon>
      Edit Product } @else {
      <mat-icon>add_circle</mat-icon>
      Create New Product }
    </h1>
  </mat-toolbar>

  <div class="form-content">
    <!-- Loading State -->
    @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading product...</p>
    </div>
    }

    <!-- Form -->
    @if (!isLoading()) {
    <mat-card class="form-card">
      <mat-card-content>
        <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
          <!-- Product Name -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Product Name</mat-label>
            <input matInput type="text" formControlName="name" placeholder="e.g., Premium Laptop" />
            <mat-icon matPrefix>label</mat-icon>
            @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
            <mat-error>{{ getErrorMessage('name') }}</mat-error>
            }
          </mat-form-field>

          <!-- Description -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Describe your product in detail..."
              rows="5"
            ></textarea>
            <mat-icon matPrefix>description</mat-icon>
            @if (productForm.get('description')?.invalid && productForm.get('description')?.touched)
            {
            <mat-error>{{ getErrorMessage('description') }}</mat-error>
            }
            <mat-hint>Minimum 10 characters</mat-hint>
          </mat-form-field>

          <!-- Price -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Price</mat-label>
            <input
              matInput
              type="number"
              formControlName="price"
              placeholder="0.00"
              step="0.01"
              min="0"
            />
            <span matPrefix>â‚¬&nbsp;</span>
            <mat-icon matSuffix>attach_money</mat-icon>
            @if (productForm.get('price')?.invalid && productForm.get('price')?.touched) {
            <mat-error>{{ getErrorMessage('price') }}</mat-error>
            }
            <mat-hint>Enter product price in Euros</mat-hint>
          </mat-form-field>

          <!-- Image Upload Section -->
          <div class="image-upload-section">
            <h3>
              <mat-icon>photo_library</mat-icon>
              Product Images
            </h3>
            <p class="hint">Add images to showcase your product (Max 2MB per image)</p>

            <!-- File Input -->
            <div class="upload-area">
              <input
                #imageInput
                type="file"
                id="imageInput"
                accept="image/*"
                multiple
                (change)="onFilesSelected($event)"
                hidden
              />
              <button
                mat-stroked-button
                type="button"
                color="primary"
                (click)="imageInput.click()"
                class="upload-btn"
              >
                <mat-icon>cloud_upload</mat-icon>
                Upload Images
              </button>
              <p class="upload-hint">Supported: JPEG, PNG, GIF, WebP</p>
            </div>

            <!-- Upload Error -->
            @if (uploadError()) {
            <div class="upload-error">
              <mat-icon>error</mat-icon>
              {{ uploadError() }}
            </div>
            }

            <!-- Existing Images (Edit Mode) -->
            @if (existingImageUrls().length > 0) {
            <div class="images-section">
              <h4>Current Images</h4>
              <div class="images-grid">
                @for (url of existingImageUrls(); track url; let i = $index) {
                <div class="image-preview-card">
                  <img [src]="url" alt="Product image {{ i + 1 }}" />
                  <button
                    mat-icon-button
                    type="button"
                    color="warn"
                    (click)="removeExistingImage(i)"
                    class="remove-btn"
                    matTooltip="Remove image"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                  <mat-chip class="image-badge">Existing</mat-chip>
                </div>
                }
              </div>
            </div>
            }

            <!-- New Image Previews -->
            @if (imagePreviews().length > 0) {
            <div class="images-section">
              <h4>New Images</h4>
              <div class="images-grid">
                @for (preview of imagePreviews(); track preview; let i = $index) {
                <div class="image-preview-card">
                  <img [src]="preview" alt="New image {{ i + 1 }}" />
                  <button
                    mat-icon-button
                    type="button"
                    color="warn"
                    (click)="removeNewImage(i)"
                    class="remove-btn"
                    matTooltip="Remove image"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                  <mat-chip class="image-badge new">New</mat-chip>
                </div>
                }
              </div>
            </div>
            }

            <!-- No Images State -->
            @if (existingImageUrls().length === 0 && imagePreviews().length === 0) {
            <div class="no-images">
              <mat-icon>image</mat-icon>
              <p>No images added yet</p>
            </div>
            }
          </div>

          <!-- Success Message -->
          @if (successMessage()) {
          <div class="success-message">
            <mat-icon>check_circle</mat-icon>
            {{ successMessage() }}
          </div>
          }

          <!-- Error Message -->
          @if (errorMessage()) {
          <div class="error-message">
            <mat-icon>error</mat-icon>
            {{ errorMessage() }}
          </div>
          }

          <!-- Form Actions -->
          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="cancel()" [disabled]="isSaving()">
              <mat-icon>cancel</mat-icon>
              Cancel
            </button>

            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="isSaving() || productForm.invalid"
            >
              @if (isSaving()) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Saving...</span>
              } @else { @if (isEditMode()) {
              <mat-icon>save</mat-icon>
              <span>Update Product</span>
              } @else {
              <mat-icon>add</mat-icon>
              <span>Create Product</span>
              } }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
    }
  </div>
</div>
